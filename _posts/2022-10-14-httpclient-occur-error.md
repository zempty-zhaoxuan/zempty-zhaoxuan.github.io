---
layout: post
title: "postman,浏览器测试接口正常，HttpClient 调用就报错"
date: 2022-10-14
toc: true
excerpt: 事情是这样的：第三方提供了一个接口需要对接，我就对接了，测试环节的时候怎么都调不通，各种排查，各方人员都动员了起来，就是没有找到问题，下面把问题报错的原因呈上...
tags: [backend,java]
comment: true
author: zempty
---

### 一次奔溃的经历

事情是这样的：第三方提供了一个接口需要对接，我就对接了，测试环节的时候怎么都调不通，各种排查，各方人员都动员了起来，就是没有找到问题，下面把问题报错的原因呈上：

![][image-1]

就是报错 508 ，返回一个空的 Response body.

刚开始出现这个问题，我怀疑是不是我的代码哪里没有处理好呢？
检查了一遍没有发现什么问题。

返回 508 什么意思？
> 508 码表示服务器中断一个操作，因为它在处理具有"Depth: infinity"的请求时遇到了一个无限循环。508 码表示整个操作失败。

请求接口走的代理服务器，我方配置了一个代理服务器去访问接口，于是我就怀疑是不是我方 nginx 哪里做了限制，导致出现的问题呢？

我去找了我方运维询问相关问题，运维通过 curl 命令直接访问接口也是返回 508 ，于是我就断定是第三方的配置出了问题。

就在这时候我的同事用 postman 和浏览器测试说接口没问题，有返回值，惊呆了我，于是我就用 postman 和浏览器都测试了一遍，果然接口没有问题。

卧槽，第三方提供的接口是没有问题的,那就是我的问题喽。。。
我静下心来，重新捋了一遍代码，还是没发现有啥问题。

### 各方交战

我把接口的详细请求参数发给了第三方，第三方测试没有问题，第三方说让我方在检查一下，我和同事包括运维的同事都头大了，各种排查。

第三方说是我方的问题，我方认为是第三方的问题，问题陷入了僵局，没办法只能借助万能的互联网看看能不能解决相关问题。

我搜到了这样一个相关的问题：

> RestTemplate请求第三方接口，返回508 ，postman请求没问题，浏览器访问也没问题，什么情况?

![][image-2]

我再次看了一下第三方给的接口文档，再次捋了一遍代码，毫无头绪。。。
这样这次的对接只能搁置下来，偶尔就过来尝试处理一下。

### 偶然的运气

postman 和浏览器测试都通过，httpclient 调用去出现问题，二者有什么区别呢？
浏览器访问了一下接口，使用 Charles 抓包工具进行抓包分析：

![][image-3]

尼玛浏览器访问接口有很多头部信息，估计是这里有猫腻。
就在这个时候一个同事也猜测可能是请求头部信息的问题，经过尝试问题得解：
是少了一个头部信息 User-Agent 头部参数。

User\_Agent 是什么？
> User-Agent是Http协议中的一部分，属于头域的组成部分，User Agent也简称UA。用较为普通的一点来说，是一种向访问网站提供你所使用的浏览器类型、操作系统及版本、CPU 类型、浏览器渲染引擎、浏览器语言、浏览器插件等信息的标识。UA字符串在每次浏览器 HTTP 请求时发送到服务器！

我尼玛，这个问题至此解决了，经过扯皮问题还是出现在第三方，第三方服务器进行了设置对该请求接口的头部信息进行了验证。

bug 解决的不容易，太耗精力了，折磨的想打人，还想哭。。。


[image-1]:	https://raw.githubusercontent.com/zempty-zhaoxuan/pics/master/508test.png
[image-2]:	https://raw.githubusercontent.com/zempty-zhaoxuan/pics/master/B07CA78A-A255-4CF4-A29C-A406496C4785.png
[image-3]:	https://raw.githubusercontent.com/zempty-zhaoxuan/pics/master/640F3E9E-BB65-45E4-B5A1-2DFAF7BB9CAB.png